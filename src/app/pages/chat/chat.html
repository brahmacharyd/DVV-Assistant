<div class="chat-root">
  <header class="chat-header">
    <div class="chat-header-left">
      <div class="chat-logo" aria-hidden="true"></div>
      <h1 class="chat-title">Dvv assistant</h1>
    </div>
    <ng-container *ngIf="chat.history$ | async as history">
    </ng-container>
  </header>

  <main #scroller (scroll)="onScroll()" class="chat-scroll">
    <ng-container *ngIf="chat.history$ | async as history">
      <ng-container *ngFor="let m of history; index as i; trackBy: trackByIdx">
        <div class="chat-row" [class.chat-row-right]="m.role === 'user'">
          <div *ngIf="m.role === 'assistant'" class="chat-avatar">AI</div>

          <div class="chat-bubble" [class.chat-bubble-user]="m.role === 'user'"
            [class.chat-bubble-assistant]="m.role === 'assistant'" [class.chat-bubble-system]="m.role === 'system'">
            <p class="chat-text">{{ m.content }}</p>
          </div>

          <div *ngIf="m.role === 'user'" class="chat-avatar user">You</div>
        </div>
      </ng-container>
    </ng-container>

    <div #endAnchor></div>
  </main>

  <button *ngIf="showJump" (click)="jumpToLatest()" class="jump-latest" type="button">
    Jump to latest ↓
  </button>

  <form (ngSubmit)="send()" class="chat-composer">
    <div class="composer-inner">
      <div class="composer-input-wrap">
        <textarea #composer [(ngModel)]="input" name="q" (input)="autosizeComposer()" (keydown)="onKeydown($event)"
          rows="1" placeholder="Type a message…" class="composer-input"></textarea>

        <button type="submit" class="send-btn" [class.loading]="sending" [disabled]="(!input?.trim() && !sending)"
          [attr.aria-label]="sending ? 'Stop' : 'Send'" (click)="sending ? stop() : null">
          <svg *ngIf="!sending" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path
              d="M7.05 12.95a.75.75 0 0 1-1.06-1.06l5.47-5.47a1.5 1.5 0 0 1 2.12 0l5.47 5.47a.75.75 0 1 1-1.06 1.06L13.5 7.96v9.54a.75.75 0 0 1-1.5 0V7.96l-4.95 4.99z" />
          </svg>

          <svg *ngIf="sending" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
            <rect x="7" y="7" width="10" height="10" rx="2" ry="2"></rect>
          </svg>
        </button>
      </div>
    </div>
    <div class="safe-area"></div>
  </form>
</div>